#!/usr/bin/env bash
# Search icon themes with fzf preview
# Usage: icon-search [query]

# Auto-provide chafa via nix shell if missing
if ! command -v chafa &>/dev/null; then
    exec nix shell nixpkgs#chafa --command "$0" "$@"
fi

ICON_DIRS=(
    "/run/current-system/sw/share/icons"
    "$HOME/.local/share/icons"
    "$HOME/.icons"
)

# Find all SVG/PNG icons, extract name and path
find -L "${ICON_DIRS[@]}" -type f \( -name '*.svg' -o -name '*.png' \) 2>/dev/null \
    | awk -F/ '{name=$NF; sub(/\.(svg|png)$/, "", name); print name "\t" $0}' \
    | sort -u -t$'\t' -k1,1 \
    | fzf --query="${1:-}" \
          --delimiter='\t' \
          --with-nth=1 \
          --preview='
            file={2}
            echo "Path: $file"
            echo "---"
            if [[ "$file" == *.svg ]]; then
                magick -background none "$file" -resize 128x128 png:- 2>/dev/null | chafa -f sixel -s 20 --animate=off 2>/dev/null || head -20 "$file"
            else
                chafa -f sixel -s 20 --animate=off "$file" 2>/dev/null || echo "(no sixel support)"
            fi
          ' \
          --preview-window=right:50% \
    | cut -f2
